<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Map</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            margin-top: 20px;
        }

        /* === Lot zoom button styles=== */
        .lot-label-container {
            border: none !important;
            background: none !important;
        }

        .lot-zoom-btn {
            background-color: #003262;
            color: white;
            padding: 5px 10px;
            border: 2px solid #ffc107;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .lot-zoom-btn:hover {
            background-color: #00569a;
        }

        /* === Go To My Spot button styling === */
        .go-to-spot-btn {
            background-color: #003262;
            color: white;
        }

        .go-to-spot-btn:hover {
            background-color: #00569a;
        }

        .parking-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        /* ========================================== */
        
        .current-parking {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .current-parking h3 {
            color: #155724;
            margin-bottom: 10px;
        }
        
        .zone-status-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .zone-status-panel h3 {
            margin-top: 0;
            color: #003262;
            border-bottom: 2px solid #003262;
            padding-bottom: 10px;
        }
        
        .lot-zone-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .lot-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .lot-card h4 {
            margin: 0 0 10px 0;
            color: #003262;
        }
        
        .zone-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            margin: 5px 5px 5px 0;
            font-size: 14px;
            font-weight: bold;
        }
        
        .zone-badge.active {
            opacity: 1;
        }
        
        .zone-badge.inactive {
            opacity: 0.4;
            text-decoration: line-through;
        }
        
        .zone-badge.green {
            background: #28a745;
            color: white;
        }
        
        .zone-badge.gold {
            background: #ffc107;
            color: #000;
        }
        
        .zone-badge.h-zone {
            background: #17a2b8;
            color: white;
        }
        
        .legend {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .legend h4 {
            margin-top: 0;
            color: #003262;
        }
        
        .legend-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }
        
        .spot-popup {
            font-family: Arial, sans-serif;
        }
        
        .spot-popup h4 {
            margin: 0 0 10px 0;
            color: #003262;
        }
        
        .spot-popup p {
            margin: 5px 0;
        }
        
        .claim-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .claim-btn:hover {
            background-color: #218838;
        }
        
        .unclaim-btn {
            background-color: #dc3545;
        }
        
        .unclaim-btn:hover {
            background-color: #c82333;
        }

        .time-notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <a href="{{ url_for('home') }}" class="back-link">← Back</a>
            <h1>UC Merced Parking Map</h1>
        </header>

        <main>
            <!-- Current Parking Status -->
            <div id="parking-status"></div>

            <!-- Zone Status Panel -->
            <div class="zone-status-panel">
                <h3>Current Zone Availability by Lot</h3>
                <div id="zone-status-info" class="lot-zone-info">
                    <p>Loading zone information...</p>
                </div>
            </div>

            <!-- Map Container -->
            <div id="map"></div>

            <!-- Legend -->
            <div class="legend">
                <h4>Legend</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #28a745;"></div>
                    <span>Green Zone - All Users</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffc107;"></div>
                    <span>Gold Zone - Faculty Only</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #17a2b8;"></div>
                    <span>H Zone - On-Campus Students Only</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #dc3545;"></div>
                    <span>Occupied Spot</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #6c757d;"></div>
                    <span>Inactive Spot</span>
                </div>
            </div>
        </main>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentParkingStatus = {};
        let allMarkers = [];

        /* ===  Campus bounds + constrained map === */
        const ucMercedBounds = [
            [37.35, -120.44], // Southwest
            [37.38, -120.41]  // Northeast
        ];

        const map = L.map('map', {
            minZoom: 15,
            maxZoom: 18,
            maxBounds: ucMercedBounds,
            maxBoundsViscosity: 1.0
        }).setView([37.3653, -120.4250], 15);
        /* ================================================================ */

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // === function to zoom to claimed spot ===
        function goToClaimedSpot(lat, lon) {
            map.flyTo([lat, lon], 18, {
                duration: 1.5
            });
        }

        // === function to zoom to lot center from button ===
        function zoomToLot(lat, lon) {
            map.flyTo([lat, lon], 18, {
                duration: 1.0
            });
        }
        // ===========================================

        // Load zone status information
        fetch('/api/zone-status')
            .then(response => response.json())
            .then(data => {
                displayZoneStatus(data);
            })
            .catch(error => {
                console.error('Error loading zone status:', error);
            });

        // Load user's accessible zones
        fetch('/api/my-accessible-zones')
            .then(response => response.json())
            .then(data => {
                if (data.has_permit) {
                    displayAccessibleZones(data);
                }
            })
            .catch(error => {
                console.error('Error loading accessible zones:', error);
            });

        // Load parking status
        fetch('/my-parking-status')
            .then(response => response.json())
            .then(status => {
                // NOTE: we only store it here; we wait to render until markers are loaded
                currentParkingStatus = status;
            });

        // Fetch parking data
        fetch('/api/parking-data')
            .then(response => response.json())
            .then(data => {
                displayParkingSpots(data);
            });

        function displayZoneStatus(data) {
            const zoneStatusDiv = document.getElementById('zone-status-info');
            
            if (!data.lots || data.lots.length === 0) {
                zoneStatusDiv.innerHTML = '<p>No zone information available.</p>';
                return;
            }

            let html = '';
            data.lots.forEach(lot => {
                html += `
                    <div class="lot-card">
                        <h4>${lot.lot_name}</h4>
                        <div>
                `;
                
                lot.zones.forEach(zone => {
                    const zoneClass = zone.zone_type === 'Green' ? 'green' : 
                                     zone.zone_type === 'Gold' ? 'gold' : 'h-zone';
                    const activeClass = zone.is_active ? 'active' : 'inactive';
                    const statusText = zone.is_active ? '✓' : '✗';
                    
                    html += `
                        <span class="zone-badge ${zoneClass} ${activeClass}">
                            ${statusText} ${zone.zone_type} Zone
                        </span>
                    `;
                });

                // Add time-based notice for North Bowl
                if (lot.lot_name === 'North Bowl') {
                    const currentHour = new Date().getHours();
                    const isNighttime = currentHour >= 19 || currentHour < 6;
                    
                    html += `
                        <div class="time-notice">
                            <strong>Time-Based Access</strong><br>
                            ${isNighttime ? 
                                'Nighttime (7 PM - 6 AM): Green Zone active for all users' : 
                                'Daytime (6 AM - 7 PM): Gold Zone active for faculty only'}
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            });

            zoneStatusDiv.innerHTML = html;
        }

        function displayAccessibleZones(data) {
            // Add to your zone status panel
            let html = `
                <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>Your ${data.permit_category} Permit allows access to:</strong><br>
                    ${data.accessible_zones.map(z => {
                        const zoneClass = z === 'Green' ? 'green' : 
                                         z === 'Gold' ? 'gold' : 'h-zone';
                        return `<span class="zone-badge ${zoneClass} active">${z} Zone</span>`;
                    }).join('')}
                </div>
            `;
            
            // Prepend to zone status panel
            document.getElementById('zone-status-info').insertAdjacentHTML('beforebegin', html);
        }

        function displayParkingStatus(status) {
            const statusDiv = document.getElementById('parking-status');
            
            if (!status.has_permit) {
                statusDiv.innerHTML = `
                    <div class="error-message">
                        <p>⚠️ You need an active permit to claim parking spots.</p>
                    </div>
                `;
            } else if (status.is_parked) {
                // Find the claimed spot's coordinates from the allMarkers array
                const claimedSpot = allMarkers.find(m => m.spot.spot_num === status.spot);
                
                let lat = null;
                let lon = null;

                if (claimedSpot) {
                    lat = claimedSpot.spot.latitude;
                    lon = claimedSpot.spot.longitude;
                }

                statusDiv.innerHTML = `
                    <div class="current-parking">
                        <h3>Currently Parked</h3>
                        <p><strong>Spot:</strong> ${status.spot}</p>
                        <p><strong>Lot:</strong> ${status.lot}</p>
                        <p><strong>Zone:</strong> ${status.zone}</p>
                        <p><strong>Arrival:</strong> ${new Date(status.arrival_time).toLocaleString()}</p>
                        <div class="parking-actions">
                            ${lat !== null && lon !== null 
                                ? `<button onclick="goToClaimedSpot(${lat}, ${lon})" class="primary-btn go-to-spot-btn">Go To My Spot</button>` 
                                : ''}
                            <button onclick="unclaimSpot()" class="primary-btn unclaim-btn">Leave Spot</button>
                        </div>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="info-box">
                        <p>✓ You have an active permit. Click on an available spot to claim it!</p>
                    </div>
                `;
            }
        }

        function displayParkingSpots(spots) {
            // Clear existing markers in case of refresh
            allMarkers.forEach(m => map.removeLayer(m.marker));
            allMarkers = [];

            spots.forEach(spot => {
                let color;
                if (!spot.is_active) {
                    color = '#6c757d';
                } else if (spot.is_occupied) {
                    color = '#dc3545';
                } else if (spot.zone_type === 'Green') {
                    color = '#28a745';
                } else if (spot.zone_type === 'Gold') {
                    color = '#ffc107';
                } else if (spot.zone_type === 'H') {
                    color = '#17a2b8';
                } else {
                    color = '#6c757d';
                }

                const marker = L.circleMarker([spot.latitude, spot.longitude], {
                    radius: 8,
                    fillColor: color,
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                let popupContent = `
                    <div class="spot-popup">
                        <h4>Spot ${spot.spot_num}</h4>
                        <p><strong>Lot:</strong> ${spot.lot_name}</p>
                        <p><strong>Zone:</strong> ${spot.zone_type}</p>
                        <p><strong>Status:</strong> ${spot.is_occupied ? 'Occupied' : 'Available'}</p>
                        ${!spot.is_active ? '<p style="color: red;"><strong>Inactive</strong></p>' : ''}
                `;

                // Add claim button if spot is available and user not parked
                if (!spot.is_occupied && spot.is_active && currentParkingStatus.has_permit && !currentParkingStatus.is_parked) {
                    popupContent += `
                        <button onclick="claimSpot('${spot.spot_num}')" class="claim-btn">
                            Claim This Spot
                        </button>
                    `;
                }

                popupContent += `</div>`;

                marker.bindPopup(popupContent);
                marker.addTo(map);

                allMarkers.push({ marker: marker, spot: spot });
            });

            addLotLabels(spots);

            // Now that markers are ready, show parking status so "Go To My Spot" works
            displayParkingStatus(currentParkingStatus);
        }

        // ===  clickable zoom buttons + zoom visibility logic (not just labels) ===
        const HIDE_ZOOM_LEVEL = 17;

        function updateLotButtonVisibility() {
            const currentZoom = map.getZoom();
            const lotButtons = document.querySelectorAll('.lot-label-container');

            if (currentZoom >= HIDE_ZOOM_LEVEL) {
                lotButtons.forEach(btn => { btn.style.display = 'none'; });
            } else {
                lotButtons.forEach(btn => { btn.style.display = 'block'; });
            }
        }

        function addLotLabels(spots) {
            const lots = {};
            spots.forEach(spot => {
                if (!lots[spot.lot_name]) {
                    lots[spot.lot_name] = { lats: [], lons: [], name: spot.lot_name };
                }
                lots[spot.lot_name].lats.push(spot.latitude);
                lots[spot.lot_name].lons.push(spot.longitude);
            });

            Object.values(lots).forEach(lot => {
                const centerLat = lot.lats.reduce((a, b) => a + b) / lot.lats.length;
                const centerLon = lot.lons.reduce((a, b) => a + b) / lot.lons.length;

                const buttonHtml = `
                    <button class="lot-zoom-btn" onclick="zoomToLot(${centerLat}, ${centerLon})">
                        ${lot.name}
                    </button>
                `;

                L.marker([centerLat, centerLon], {
                    icon: L.divIcon({
                        className: 'lot-label-container',
                        html: buttonHtml,
                        iconSize: [150, 40]
                    })
                }).addTo(map);
            });

            // Set initial visibility based on starting zoom
            updateLotButtonVisibility();
        }

        map.on('zoomend', updateLotButtonVisibility);
        // ===================================================

        function claimSpot(spotNum) {
            fetch(`/claim-spot/${spotNum}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✓ ${data.message}`);
                    location.reload(); // Refresh to update map
                } else {
                    alert(`⚠️ ${data.message}`);
                }
            })
            .catch(error => {
                alert('Error claiming spot. Please try again.');
                console.error(error);
            });
        }

        function unclaimSpot() {
            if (!confirm('Are you sure you want to leave this parking spot?')) {
                return;
            }

            fetch('/unclaim-spot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✓ ${data.message}`);
                    location.reload(); // Refresh to update map
                } else {
                    alert(`⚠️ ${data.message}`);
                }
            })
            .catch(error => {
                alert('Error unclaiming spot. Please try again.');
                console.error(error);
            });
        }
    </script>
</body>
</html>
